<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puzzle Box - MakerWorld Path Generator</title>
    <style>
        :root {
            --bg: #1a1a2e;
            --card: #16213e;
            --accent: #e94560;
            --text: #eaeaea;
            --input-bg: #0f3460;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
        }
        
        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--accent), #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            color: #888;
            margin-top: 10px;
        }
        
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: var(--accent);
            margin-bottom: 20px;
            font-size: 1.2rem;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        input[type="number"],
        select {
            background: var(--input-bg);
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px;
            color: var(--text);
            font-size: 1rem;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .seed-refresh {
            display: flex;
            gap: 10px;
        }
        
        .seed-refresh input {
            flex: 1;
        }
        
        .seed-refresh button {
            padding: 10px 15px;
            font-size: 0.9rem;
        }
        
        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(233, 69, 96, 0.4);
        }
        
        button.secondary {
            background: var(--input-bg);
        }
        
        .path-output {
            background: #0a0a15;
            border: 2px solid var(--accent);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 1.1rem;
            color: #7fdbca;
            word-break: break-all;
            min-height: 60px;
            margin: 15px 0;
        }
        
        .path-info {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 15px;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .info-box {
            background: #1e3a5f;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--accent);
        }
        
        .info-box ol {
            margin: 10px 0 0 20px;
        }
        
        .info-box li {
            margin: 5px 0;
        }
        
        .info-box a {
            color: var(--accent);
        }
        
        footer {
            text-align: center;
            padding: 30px;
            color: #666;
            font-size: 0.9rem;
        }
        
        footer a {
            color: var(--accent);
            text-decoration: none;
        }
        
        .highlight {
            background: linear-gradient(135deg, #1e3a5f 0%, #16213e 100%);
            border: 2px solid var(--accent);
        }
        
        .copied {
            background: #27ae60 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéÅ Puzzle Box Generator</h1>
            <p class="subtitle">Generate maze paths for MakerWorld parametric puzzle boxes</p>
        </header>
        
        <div class="info-box">
            <strong>How to use:</strong>
            <ol>
                <li>Configure your puzzle parameters below</li>
                <li>Click <strong>"üé≤ Generate Path"</strong> to create a random maze</li>
                <li>Click <strong>"üìã Copy Path"</strong> to copy it</li>
                <li>Go to <a href="https://makerworld.com/en/makerlab/parametricModelMaker" target="_blank">MakerWorld</a> and paste into the <code>path_data</code> parameter</li>
            </ol>
        </div>
        
        <div class="card">
            <h2>üìê Puzzle Settings</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Maze Seed</label>
                    <div class="seed-refresh">
                        <input type="number" id="maze_seed" value="42" min="1" max="9999">
                        <button type="button" onclick="randomSeed()">üé≤</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Maze Columns</label>
                    <select id="maze_columns">
                        <option value="6">6 (Easy)</option>
                        <option value="8" selected>8 (Medium)</option>
                        <option value="10">10 (Hard)</option>
                        <option value="12">12 (Very Hard)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Maze Rows</label>
                    <select id="maze_rows">
                        <option value="8">8 (Short)</option>
                        <option value="12" selected>12 (Medium)</option>
                        <option value="16">16 (Tall)</option>
                        <option value="20">20 (Very Tall)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Complexity</label>
                    <select id="complexity">
                        <option value="1">Simple (mostly up)</option>
                        <option value="3" selected>Medium (some turns)</option>
                        <option value="5">Complex (many turns)</option>
                        <option value="7">Very Complex</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="card highlight">
            <h2>üéØ Generated Path</h2>
            <div class="buttons">
                <button type="button" onclick="generatePath()">üé≤ Generate Path</button>
            </div>
            
            <div id="pathOutput" class="path-output">Click "Generate Path" to create a maze...</div>
            
            <div id="pathInfo" class="path-info"></div>
            
            <div class="buttons">
                <button type="button" id="copyBtn" onclick="copyPath()">üìã Copy Path</button>
                <button type="button" class="secondary" onclick="downloadTemplate()">‚¨áÔ∏è Download SCAD Template</button>
            </div>
        </div>
        
        <footer>
            <p>Based on <a href="https://github.com/revk/PuzzleBox" target="_blank">RevK's PuzzleBox</a></p>
            <p>Upload the SCAD template to MakerWorld with BOSL2 library</p>
        </footer>
    </div>
    
    <script>
        function randomSeed() {
            document.getElementById('maze_seed').value = Math.floor(Math.random() * 9999) + 1;
            generatePath();
        }
        
        function seededRandom(seed) {
            const x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
        }
        
        function generatePath() {
            const seed = parseInt(document.getElementById('maze_seed').value) || 42;
            const cols = parseInt(document.getElementById('maze_columns').value) || 8;
            const rows = parseInt(document.getElementById('maze_rows').value) || 12;
            const complexity = parseInt(document.getElementById('complexity').value) || 3;
            
            let path = "";
            let col = Math.floor(seededRandom(seed) * cols);
            let row = 0;
            let currentSeed = seed;
            
            while (row < rows - 1 && path.length < rows * 4) {
                currentSeed++;
                const rand = seededRandom(currentSeed) * 10;
                
                if (rand < complexity && col > 0) {
                    path += "L";
                    col--;
                } else if (rand < complexity * 2 && col < cols - 1) {
                    path += "R";
                    col++;
                } else {
                    path += "U";
                    row++;
                }
                
                // Add backtracking for more complexity
                if (complexity > 3 && seededRandom(currentSeed + 500) < 0.15 && row > 1) {
                    path += "D";
                    row--;
                }
            }
            
            // Ensure we reach the top
            while (row < rows - 1) {
                path += "U";
                row++;
            }
            
            document.getElementById('pathOutput').textContent = path;
            document.getElementById('pathInfo').innerHTML = 
                `<strong>Path:</strong> ${path.length} moves | ` +
                `<strong>Grid:</strong> ${cols} √ó ${rows} | ` +
                `<strong>Seed:</strong> ${seed}`;
        }
        
        function copyPath() {
            const path = document.getElementById('pathOutput').textContent;
            if (!path || path.includes('Click')) {
                alert('Generate a path first!');
                return;
            }
            
            navigator.clipboard.writeText(path).then(() => {
                const btn = document.getElementById('copyBtn');
                btn.textContent = '‚úì Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'üìã Copy Path';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }
        
        function downloadTemplate() {
            const path = document.getElementById('pathOutput').textContent;
            const pathData = (!path || path.includes('Click')) ? 'UUUURRUUULLUUURRUU' : path;
            const cols = document.getElementById('maze_columns').value;
            
            const template = `// Puzzle Box for MakerWorld
// Maze pattern on OUTSIDE of inner cylinder
// Uses BOSL2 library

include <BOSL2/std.scad>;

/* [Maze Path] */
// Paste the generated path string here
path_data = "${pathData}";

/* [Dimensions] */
inner_diameter = 30; // [20:60]
total_height = 60; // [40:100]
wall_thickness = 2; // [1.5:0.5:4]

/* [Maze Settings] */
maze_columns = ${cols}; // [4:16]
maze_step = 4; // [2:0.5:8]
wall_height = 3; // [2:0.5:5]
wall_width = 2; // [1.5:0.5:4]

/* [Outer Shell] */
outer_sides = 8; // [0:Round, 6:Hexagon, 7:Heptagon, 8:Octagon, 10:Decagon]
outer_gap = 0.4; // [0.2:0.1:0.8]

/* [Display] */
show_part = "both"; // [inner, outer, both, assembled]
separation = 50; // [0:100]

/* [Hidden] */
$fn = 64;

// Parse path into moves
function parse_path(str, i=0) = 
    i >= len(str) ? [] :
    let(c = str[i], m = c=="U"||c=="u" ? [0,1] : c=="D"||c=="d" ? [0,-1] : c=="R"||c=="r" ? [1,0] : c=="L"||c=="l" ? [-1,0] : [0,0])
    concat([m], parse_path(str, i+1));

// Build coordinates from moves
function build_coords(moves, pos=[0,0], i=0) =
    i >= len(moves) ? [pos] :
    concat([pos], build_coords(moves, [(pos[0]+moves[i][0]+maze_columns)%maze_columns, pos[1]+moves[i][1]], i+1));

// Check if path connects two cells
function connected(coords, c1,r1, c2,r2) =
    len([for(i=[0:len(coords)-2]) if((coords[i]==[c1,r1] && coords[i+1]==[c2,r2]) || (coords[i]==[c2,r2] && coords[i+1]==[c1,r1])) 1]) > 0;

// Calculate maze data
moves = parse_path(path_data);
path_coords = build_coords(moves);
maze_rows = max([for(p=path_coords) p[1]]) + 2;
inner_r = inner_diameter/2;
maze_r = inner_r + wall_thickness;
outer_r = maze_r + wall_height + outer_gap + wall_thickness;
col_ang = 360/maze_columns;
maze_height = maze_rows * maze_step;
base_height = (total_height - maze_height) / 2;

echo(str("Path: ", len(path_coords), " cells"));
echo(str("Maze: ", maze_columns, " cols x ", maze_rows, " rows"));

// INNER PART - cylinder with maze walls on OUTSIDE
module inner_part() {
    // Base cylinder
    difference() {
        cylinder(r=maze_r, h=total_height);
        translate([0, 0, wall_thickness])
            cylinder(r=inner_r, h=total_height);
    }
    
    // Maze walls on outside surface
    maze_walls();
    
    // Top and bottom rings
    translate([0, 0, base_height - wall_width/2])
        ring(maze_r, wall_height, wall_width);
    translate([0, 0, base_height + maze_height])
        ring(maze_r, wall_height, wall_width);
}

module ring(r, h, w) {
    difference() {
        cylinder(r=r+h, h=w);
        translate([0, 0, -0.1])
            cylinder(r=r, h=w+0.2);
    }
}

module maze_walls() {
    z0 = base_height;
    
    for(row = [0:maze_rows-1]) {
        z = z0 + row * maze_step;
        
        for(col = [0:maze_columns-1]) {
            ang = col * col_ang;
            next_col = (col + 1) % maze_columns;
            
            // Horizontal wall (blocks movement around)
            h_open = connected(path_coords, col, row, next_col, row);
            if(!h_open) {
                rotate([0, 0, ang + col_ang])
                translate([maze_r + wall_height/2, 0, z + maze_step/2])
                    cube([wall_height, wall_width, maze_step], center=true);
            }
            
            // Vertical wall (blocks movement up/down) - arc segment
            v_open = connected(path_coords, col, row, col, row+1);
            if(!v_open && row < maze_rows - 1) {
                rotate([0, 0, ang])
                translate([0, 0, z + maze_step])
                linear_extrude(height=wall_width, center=true)
                difference() {
                    circle(r=maze_r + wall_height);
                    circle(r=maze_r);
                    rotate([0, 0, col_ang])
                        translate([-outer_r*2, 0]) square([outer_r*4, outer_r*4]);
                    translate([-outer_r*2, -outer_r*4]) square([outer_r*4, outer_r*4]);
                }
            }
        }
    }
    
    // Entry opening at bottom
    entry_col = path_coords[0][0];
    rotate([0, 0, entry_col * col_ang])
    translate([0, 0, z0/2])
    linear_extrude(height=base_height + maze_step, center=true)
    difference() {
        circle(r=maze_r + wall_height);
        circle(r=maze_r);
        rotate([0, 0, col_ang])
            translate([-outer_r*2, 0]) square([outer_r*4, outer_r*4]);
        translate([-outer_r*2, -outer_r*4]) square([outer_r*4, outer_r*4]);
    }
    
    // Exit opening at top  
    exit_col = path_coords[len(path_coords)-1][0];
    exit_z = z0 + (maze_rows-1) * maze_step;
    rotate([0, 0, exit_col * col_ang])
    translate([0, 0, exit_z + (total_height - exit_z)/2])
    linear_extrude(height=total_height - exit_z + wall_width, center=true)
    difference() {
        circle(r=maze_r + wall_height);
        circle(r=maze_r);
        rotate([0, 0, col_ang])
            translate([-outer_r*2, 0]) square([outer_r*4, outer_r*4]);
        translate([-outer_r*2, -outer_r*4]) square([outer_r*4, outer_r*4]);
    }
}

// OUTER PART - shell with nub inside
module outer_part() {
    nub_r = maze_r + wall_height/2 + outer_gap;
    
    difference() {
        // Outer shell (polygon or round)
        if(outer_sides == 0) {
            cylinder(r=outer_r, h=total_height);
        } else {
            cylinder(r=outer_r/cos(180/outer_sides), h=total_height, $fn=outer_sides);
        }
        
        // Hollow inside
        translate([0, 0, wall_thickness])
            cylinder(r=maze_r + wall_height + outer_gap, h=total_height);
    }
    
    // Nub that follows the maze
    translate([nub_r, 0, base_height + maze_step/2])
        sphere(r=wall_width/2, $fn=16);
}

// Display parts
if(show_part == "inner" || show_part == "both") {
    color("Gold")
    translate([show_part == "both" ? -separation/2 : 0, 0, 0])
        inner_part();
}

if(show_part == "outer" || show_part == "both") {
    color("OliveDrab", 0.8)
    translate([show_part == "both" ? separation/2 : 0, 0, 0])
        outer_part();
}

if(show_part == "assembled") {
    color("Gold") inner_part();
    color("OliveDrab", 0.5) outer_part();
}
`;
            
            const blob = new Blob([template], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'puzzle_box_makerworld.scad';
            a.click();
        }
        
        // Generate initial path on load
        generatePath();
    </script>
</body>
</html>
